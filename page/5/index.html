<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
    

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.4"/>


    <meta name="description" content="少年经不得顺境,中年经不得闲境,晚年经不得逆境" />



  <meta name="keywords" content="Silence,imsilence,博客,Blogs,个人博客,Personal Blogs,Silence's Blogs" />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.4" />


<meta name="description" content="少年经不得顺境,中年经不得闲境,晚年经不得逆境">
<meta property="og:type" content="website">
<meta property="og:title" content="Silence's Blogs">
<meta property="og:url" content="http://imsilence.github.io/page/5/index.html">
<meta property="og:site_name" content="Silence's Blogs">
<meta property="og:description" content="少年经不得顺境,中年经不得闲境,晚年经不得逆境">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Silence's Blogs">
<meta name="twitter:description" content="少年经不得顺境,中年经不得闲境,晚年经不得逆境">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'hide'
  };
</script>

    <title> Silence's Blogs </title>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
<!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?d76d6abdbe271d3cca4ddb8f5649243c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



<div class="container one-column 
   page-home 
">
    <div class="headband"></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Silence's Blogs</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-archives"></i> <br />
            归档
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
<form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'YGzc19xtW4Xs6NWUE3qA','2.0.0');
</script>

<div class="site-search-toggle"></div>
    </div>
  
</nav>


        </div>
    </header>

    <main id="main" class="main">
        <div class="main-inner">
            <div id="content" class="content">
                
  <section id="posts" class="posts-expand">
    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/09/17/elasticsearch/elasticsearch_index_refresh/" itemprop="url">
                记一次elasticsearch索引数据后但查不到
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-17T18:46:21+08:00" content="2015-09-17">
            2015-09-17
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/存储/" itemprop="url" rel="index"><span itemprop="name">存储</span></a></span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/09/17/elasticsearch/elasticsearch_index_refresh/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/09/17/elasticsearch/elasticsearch_index_refresh/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>背景:需要在一堆日志中统计所有存在的源IP，日志时按天存放的，代码结构如下：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_store_hosts</span><span class="params">()</span></span>:</span><br><span class="line">   <span class="string">''</span><span class="string">'</span><br><span class="line">      返回es中存储中所有ip</span><br><span class="line">      在索引doc时未设置refresh</span><br><span class="line">   '</span><span class="string">''</span></span><br><span class="line">   <span class="keyword">return</span> _all<span class="number">_</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_distinct_hosts_from_logs</span><span class="params">(day)</span></span>:</span><br><span class="line">   <span class="string">''</span><span class="string">'</span><br><span class="line">      从日志中查询所有的ip并去重</span><br><span class="line">   '</span><span class="string">''</span></span><br><span class="line">   <span class="keyword">return</span> _hosts<span class="number">_</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store_hosts</span><span class="params">(hosts)</span></span></span><br><span class="line">   <span class="string">''</span><span class="string">'</span><br><span class="line">   将新的ip存储到es中</span><br><span class="line">   '</span><span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stat</span><span class="params">(day)</span></span>:</span><br><span class="line">   _all<span class="number">_</span> = get_all_store_hosts()</span><br><span class="line">   _hosts<span class="number">_</span> = <span class="symbol">get_distinct_hosts_from_logs:</span></span><br><span class="line">   _hosts<span class="number">_</span> = [_host <span class="keyword">for</span> _host <span class="keyword">in</span>  _hosts<span class="number">_</span> <span class="keyword">if</span> _host <span class="keyword">not</span> <span class="keyword">in</span> _all<span class="number">_</span>]</span><br><span class="line">   <span class="keyword">if</span> len(_hosts<span class="number">_</span>):</span><br><span class="line">      store_hosts(_hosts<span class="number">_</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">'__main__'</span>:</span><br><span class="line">   <span class="keyword">for</span> day <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">30</span>):</span><br><span class="line">      stat(day)</span><br></pre></td></tr></table></figure></p>
<p>各位看官觉得有问题吗？好吧，貌似没有问题，但是呢执行完成后，你会惊奇的发现es中你的统计的数据里面存储大量重复的ip</p>
<p>问题原因:<br>在文档索引的shard上到shard更新有一定时间间隔, 而只有到shard更新后才可search到文档, 也就是说文档索引后不一定可以查询到, 在es的官方文档中亦有描述，戳<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#index-refresh" title="es关于索引的refresh属性描述" target="_blank" rel="external">这里查看Refresh一节</a>, 文档亦给出解决方法在索引时使用refresh=true属性, 但是需要测试对索引和查询性能的影响</p>
<p>在这里我的解决方法：在内存中做了一个缓存，通过缓存去重，当不缓存中不存在时则存储到es，并放入缓存中，为什么可以放在内存中，原因，就算有40w的ip, 放在内存数组中时, 内存大小占用25M左右对于一般的机器足以承受</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/09/17/elasticsearch/elasticsearch_05/" itemprop="url">
                elasticsearch 第五篇(文档操作接口)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-17T13:46:21+08:00" content="2015-09-17">
            2015-09-17
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/存储/" itemprop="url" rel="index"><span itemprop="name">存储</span></a></span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/09/17/elasticsearch/elasticsearch_05/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/09/17/elasticsearch/elasticsearch_05/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="INDEX-API"><a href="#INDEX-API" class="headerlink" title="INDEX API"></a>INDEX API</h2><p>示例:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /<span class="built_in">test</span>/user/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"silence"</span>,</span><br><span class="line">  <span class="string">"age"</span>: 27</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>说明:<br>1.索引文档使用PUT方法，需要指定index(test)、type(user)和文档编号，提交数据为json格式为文档的内容<br>2.在索引文档时，会自动检查index和type是否存在，若不存在则自动创建，对于type会自动调用putmapping方法为type自动创建mapping，当提交的json数据新增字段时也会自动对type自动调用putmapping方法在mapping中添加新的字段类型<br>可通过elasticsearch.yml中添加配置禁用自动创建index和type<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">action.auto_create_index: <span class="keyword">false</span>        <span class="meta">#禁用自动创建index</span></span><br><span class="line"><span class="keyword">index</span>.mapper.dynamic: <span class="keyword">false</span>            <span class="meta">#禁用自动生成type</span></span><br></pre></td></tr></table></figure></p>
<p>在某些时候允许某类型或者禁用某类型的index自动创建，则可以使用匹配模式和黑白名单形式进行配置</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action.auto_create_index: +<span class="keyword">test</span>*,+temp*,+tmp*       #只允许自动创建以<span class="keyword">test</span>,temp,tmp开头的<span class="built_in">index</span></span><br></pre></td></tr></table></figure>
<p>说明: 若action.auto_create_index设置为true或允许某些index执行, index.mapper.dynamic设置为false, 则可第一次时index自动创建一个type，后续不能再单独创建新的type</p>
<p>3.文档中的version属性<br>es为每个文档自动设置一个version属性, version从1开始, 当文档发生更新，删除操作时version都会自增1, version是范围为[1, 9.2e+18]的整数, 在获取或查询文档是version作为文档的一部分返回<br>version属性主要使用乐观锁机保证数据在读取后再进行更新动作时的数据一致性问题，在提交请求时通过指定version参数表示存储的版本必须符合条件时才可执行成功, 默认条件为两者一致，若不提交version表示不进行检查<br>使用方法:<br>例如编号为1的文档version为7<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"_index"</span>: <span class="string">"test"</span>,</span><br><span class="line">   <span class="attr">"_type"</span>: <span class="string">"user"</span>,</span><br><span class="line">   <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">   <span class="attr">"_version"</span>: <span class="number">7</span>,</span><br><span class="line">   <span class="attr">"found"</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">"_source"</span>: &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"silence"</span>,</span><br><span class="line">      <span class="attr">"age"</span>: <span class="number">27</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当我们使用如下请求执行更新动作可看到执行成功，并且version自增1, 返回结果中为8:<br>输入:<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /<span class="keyword">test</span>/user/1?<span class="keyword">version</span>=7</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"silence"</span>,</span><br><span class="line">  <span class="string">"age"</span>: 28</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"_index"</span>: <span class="string">"test"</span>,</span><br><span class="line">   <span class="attr">"_type"</span>: <span class="string">"user"</span>,</span><br><span class="line">   <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">   <span class="attr">"_version"</span>: <span class="number">8</span>,</span><br><span class="line">   <span class="attr">"created"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当我们再次发出version=7的请求得到的响应为:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   "error": "VersionConflictEngineException[<span class="string">[test</span>][<span class="symbol">2</span>] [<span class="string">user</span>][<span class="symbol">1</span>]: version conflict, current [8], provided [7]]",</span><br><span class="line">   "status": 409</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可自己测试version&gt;8的请求依然失败, 此时你可能会想到在高并发情况下此种效率是否会低效, 可能你会在内存中放置一个version+1的副本, 通过内存中对副本进行自增, 然后异步方式提高并发, 此时执行成功率会下降并且导致数据丢失, 在此种情况下只要满足你指定的version大于存储中的版本号即可, 为解决此种问题es提供version_type可以指定使用的比较策略：</p>
<table>
<thead>
<tr>
<th>version_type值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>internal</td>
<td>默认值, 表示指定version必须与存储中的version一致, 若成功则存储version自增1</td>
</tr>
<tr>
<td>external/external_gt</td>
<td>指定值必须大于存储中的version, 若成功存储version设置为提交的version</td>
</tr>
<tr>
<td>external_gte</td>
<td>指定值必须大于等于存储中的version, 若成功存储version设置为提交的version</td>
</tr>
<tr>
<td>force</td>
<td>强制更新，并将存储version设置为提交的version</td>
</tr>
</tbody>
</table>
<p>4.op_type: 在提交请求时指定op_type=create, 表示若id不存在时创建, 否则失败<br>输入<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /<span class="built_in">test</span>/user/1?op_<span class="built_in">type</span>=create</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"silence"</span>,</span><br><span class="line">  <span class="string">"age"</span>: 28</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   "error": "DocumentAlreadyExistsException[<span class="string">[test</span>][<span class="symbol">2</span>] [<span class="string">user</span>][<span class="symbol">1</span>]: document already exists]",</span><br><span class="line">   "status": 409</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>op_type=create的另一种表示方法为:<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT <span class="meta-keyword">/test/</span>user/<span class="number">1</span>/<span class="class">_create</span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"silence"</span>,</span><br><span class="line">  <span class="string">"age"</span>: <span class="number">28</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.ID生成器: 在大多数情况下我们不需要维护也不关心文档的id是什么, 在es中可以为文档自动生成id，方式为使用post方式提交参数, 并在请求中不指定id值(若指定则使用指定的id值)<br>6.routing路由分配: 在创建index时通常会将index数据存放在不同的shard上，es默认通过hash(id) % shard_num决定将文档存储在哪个shard上，此刻你应该想到routing的作用，对，就是用来指定做负载是hash的输入参数:<br>输入:<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST <span class="meta-keyword">/test/</span>user/?routing=<span class="class">name</span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"silence"</span>,</span><br><span class="line">  <span class="string">"age"</span>: <span class="number">28</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>若在索引文档时显示指定routing，则在提交文档中必须存在指定routing对应的值，否则执行失败</p>
<p>7.分布式执行<br>索引操作会被路由到shard上，并在包含该shard的node中执行，若存在复制shard，则当所有复制节点从主shard中执行成功后，返回结果</p>
<p>8.一致性<br>为防止某些网络节点错误，默认情况下当索引成功数量&gt;=仲裁(replicas/2+1)时，则认为操作成功，对于复制数量为1时则数据一共存两份（主shard和复制shard），此时若主shard写成功则认为执行成功<br>可在elasticsearch.yml中将action.write_consistency设置为one,all,quorum修改判断依据</p>
<p>9.刷新shard<br>为了在索引文档成功后立即查询到文档(当shard刷新后才可search到), 可以通过设置refresh=true在索引文档成功后立即执行存储该数据shard的刷新动作, 在设置前应该对索引和查询进行对性能测试，对于get接口获取文档是完全实时的</p>
<p>再次分享自己趟过的一个坑:<br>背景:需要在一堆日志中统计所有存在的源IP，日志时按天存放的，代码结构如下：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_store_hosts</span><span class="params">()</span></span>:</span><br><span class="line">   <span class="string">''</span><span class="string">'</span><br><span class="line">      返回es中存储中所有ip</span><br><span class="line">      在索引doc时未设置refresh</span><br><span class="line">   '</span><span class="string">''</span></span><br><span class="line">   <span class="keyword">return</span> _all<span class="number">_</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_distinct_hosts_from_logs</span><span class="params">(day)</span></span>:</span><br><span class="line">   <span class="string">''</span><span class="string">'</span><br><span class="line">      从日志中查询所有的ip并去重</span><br><span class="line">   '</span><span class="string">''</span></span><br><span class="line">   <span class="keyword">return</span> _hosts<span class="number">_</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store_hosts</span><span class="params">(hosts)</span></span></span><br><span class="line">   <span class="string">''</span><span class="string">'</span><br><span class="line">   将新的ip存储到es中</span><br><span class="line">   '</span><span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stat</span><span class="params">(day)</span></span>:</span><br><span class="line">   _all<span class="number">_</span> = get_all_store_hosts()</span><br><span class="line">   _hosts<span class="number">_</span> = <span class="symbol">get_distinct_hosts_from_logs:</span></span><br><span class="line">   _hosts<span class="number">_</span> = [_host <span class="keyword">for</span> _host <span class="keyword">in</span>  _hosts<span class="number">_</span> <span class="keyword">if</span> _host <span class="keyword">not</span> <span class="keyword">in</span> _all<span class="number">_</span>]</span><br><span class="line">   <span class="keyword">if</span> len(_hosts<span class="number">_</span>):</span><br><span class="line">      store_hosts(_hosts<span class="number">_</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name_<span class="number">_</span> == <span class="string">'__main__'</span>:</span><br><span class="line">   <span class="keyword">for</span> day <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">30</span>):</span><br><span class="line">      stat(day)</span><br></pre></td></tr></table></figure></p>
<p>各位看着有问题吗？好吧，貌似没有问题，但是呢执行完成后，你会惊奇的发现es中你的统计的数据里面存储大量重复的ip，问题原因大家已经知道了吧</p>
<p>解决方法：我在内存中做了一个缓存，通过缓存去重，当在缓存中不存在时则放入缓存中并存储到es</p>
<ol>
<li>timeout<br>当文档被索引时会从主shard将数据复制到复制shard, 主shard需要等待复制shard的响应后返回执行结果, 此等待时间默认为1min, 可以通过在请求中添加timeout修改此时间</li>
</ol>
<h2 id="GET-API"><a href="#GET-API" class="headerlink" title="GET API"></a>GET API</h2><p>示例:<br>输入:<br><code>GET /test/user/1</code><br>输入:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"_index"</span>: <span class="string">"test"</span>,</span><br><span class="line">   <span class="attr">"_type"</span>: <span class="string">"user"</span>,</span><br><span class="line">   <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">   <span class="attr">"_version"</span>: <span class="number">3</span>,</span><br><span class="line">   <span class="attr">"found"</span>: <span class="literal">true</span>,</span><br><span class="line">   <span class="attr">"_source"</span>: &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"silence"</span>,</span><br><span class="line">      <span class="attr">"age"</span>: <span class="number">28</span>,</span><br><span class="line">      <span class="attr">"book"</span>: &#123;</span><br><span class="line">         <span class="attr">"name"</span>: <span class="string">"迷失的自己"</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>说明:<br>1.可以通过GET方法根据文档的ID读取文档内容<br>_index,_type,_id三元组唯一标识一个文档, 分别表示索引，类型和文档id<br>_version为文档的版本<br>found表示是否查询到结果, true表示存在, false表示不存在<br>_source是真正的文档内容</p>
<p>2.可以通过HEAD方法根据reponse header信息判断文档是否存在<br>输入:<code>curl -XHEAD -i &quot;http://localhost:9200/test/user/1&quot;</code><br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span>: text/plain; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span>: 0`</span><br></pre></td></tr></table></figure></p>
<p>输入:<code>curl -XHEAD -i &quot;http://localhost:9200/test/user/1</code><br>输出:<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 <span class="number">404</span> Not Found</span><br><span class="line"><span class="attribute">Content-Type</span>: text/plain; charset=UTF-8</span><br><span class="line"><span class="attribute">Content-Length</span>: 0</span><br></pre></td></tr></table></figure></p>
<p>可以看到若文档存在使用HEAD方法则返回状态码为200，否则状态码为404</p>
<p>3.GET操作默认是实时的，也就是说文档索引后可立即读取，并不像Search需要等待shard刷新，但是通过在GET请求中通过参数realtime=false或者在elasticsearch.yml配置action.get.realtime:false禁用<br>4.在GET数据时可以使用”_all”替代要查询的_type, 此时会返回在所有type中第一个匹配到的document<br>5.在GET数据时可以通过_source, _source_include &amp; _source_exclude设置返回文档包含的属性<br>输入: <code>GET /test/user/1?_source=false</code> 不返回任何_source内容<br>输入: <code>GET /test/user/1?_source=name</code> 只返回_source中的name<br>输入: <code>GET /test/user/1?_source_include=*.name&amp;_source_exclude=name</code></p>
<p>_source常用于需要返回一两个字段的情况, 内容较多的文档属性值进行筛选时可以组合_source_include和_source_exclude<br>6.若只想返回_source中的内容可以使用:<code>GET /test/user/1/_source</code><br>7.若在索引文档时指定了routing_key为了可以正确GET到文档,则需要在GET请求中添加routing指定正确的routing_key<br>8.默认GET文档执行在复制shard的上，但可以通过设置preference为_primary或者_local, _primary表示在主shard上执行, _local表示在一个分配且可用的shard上执行<br>9.GET请求中也可以添加refresh=true参数强制使获取文档相关shard刷新, 从而可以被search到<br>10.在GET请求发出后，会根据需要获取文档id将请求转发到一个相关的复制节点上执行并返回结果<br>11.可以在GET请求中指定version属性用于需要获取符合规则version的文档</p>
<h2 id="DELETE-API"><a href="#DELETE-API" class="headerlink" title="DELETE API"></a>DELETE API</h2><p>示例:<br>输入<br><code>DELETE /test/user/1</code></p>
<p>说明:<br>1.在DELETE方法提交的参数中可以设置version属性用于删除符合规则的version文档<br>2.当在index文档是设置routing_key, 那么在删除文档时也需要使用routing设置正确的routing_key<br>3.当删除文档是若index不存在, 则es会自动创建<br>4.删除文档请求会被转发到主shard上, 主shard操作完成后, 各复制shard会从主shard进行同步<br>5.</p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/09/16/elasticsearch/elasticsearch_04/" itemprop="url">
                elasticsearch 第四篇(API约定)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-16T15:46:21+08:00" content="2015-09-16">
            2015-09-16
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/存储/" itemprop="url" rel="index"><span itemprop="name">存储</span></a></span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/09/16/elasticsearch/elasticsearch_04/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/09/16/elasticsearch/elasticsearch_04/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="对多个indices进行操作"><a href="#对多个indices进行操作" class="headerlink" title="对多个indices进行操作"></a>对多个indices进行操作</h2><p>es中大多resetapi支持请求多个index, 例如”test1,test2,test3”，index也可以使用通配符, 例如”test*“, 还可以使用+,-来包含或移除某个或某类index, 例如”test*,-test1”<br>支持设置多个的api的请求字符串可设置以下参数:</p>
<ul>
<li>ignore_unavailable: 是否忽略单个index是否可用(不存在或关闭), true表示忽略, false表示不忽略, 默认为false, 例如查询已经关闭的index:</li>
</ul>
<p>输入: <code>GET /test1/user,account/_search?ignore_unavailable=false</code><br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"error"</span>: <span class="string">"IndexClosedException[[test1] closed]"</span>,</span><br><span class="line">   <span class="attr">"status"</span>: <span class="number">403</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输入: <code>GET /test1/user,account/_search?ignore_unavailable=false</code><br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"took"</span>: <span class="number">1</span>,</span><br><span class="line">   <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">"_shards"</span>: &#123;</span><br><span class="line">      <span class="attr">"total"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"successful"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"hits"</span>: &#123;</span><br><span class="line">      <span class="attr">"total"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"max_score"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"hits"</span>: []</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>allow_no_indices: 是否忽略通配符匹配不到index(不存在或关闭)的情况, true表示允许, false表示不允许，默认为true, 例如查询已经关闭的index:</li>
</ul>
<p>输入: <code>GET /test*/_search?allow_no_indices=false</code><br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"error"</span>: <span class="string">"IndexMissingException[[test*] missing]"</span>,</span><br><span class="line">   <span class="attr">"status"</span>: <span class="number">404</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输入: <code>GET /test*/_search?allow_no_indices=true</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"took"</span>: <span class="number">1</span>,</span><br><span class="line">   <span class="attr">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">"_shards"</span>: &#123;</span><br><span class="line">      <span class="attr">"total"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"successful"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"failed"</span>: <span class="number">0</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"hits"</span>: &#123;</span><br><span class="line">      <span class="attr">"total"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"max_score"</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">"hits"</span>: []</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>expand_wildcards: 设置是否扩展通配符到closed的index中，open表示只在匹配并为open的index中查询，closed表示在匹配的所有的index中查询, 默认为closed, 例如查询已经关闭的index<br>输入: <code>GEt /test*/_search?expand_wildcards=closed</code><br>输出:<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"error"</span>: <span class="string">"IndexClosedException[[test1] closed]"</span>,</span><br><span class="line">   <span class="attr">"status"</span>: <span class="number">403</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="公共参数"><a href="#公共参数" class="headerlink" title="公共参数"></a>公共参数</h2><ul>
<li><p>format: 表示返回数据的格式, 可选值为yaml和json两种, 例如:<br>输入: <code>GET /test1/user/_search?format=yaml</code><br>输出:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">took:</span> <span class="number">23</span></span><br><span class="line"><span class="attr">timed_out:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">_shards:</span></span><br><span class="line"><span class="attr">  total:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  successful:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">  failed:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">hits:</span></span><br><span class="line"><span class="attr">  total:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  max_score:</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">  hits:</span></span><br><span class="line"><span class="attr">  - _index:</span> <span class="string">"test1"</span></span><br><span class="line"><span class="attr">    _type:</span> <span class="string">"user"</span></span><br><span class="line"><span class="attr">    _id:</span> <span class="string">"1"</span></span><br><span class="line"><span class="attr">    _score:</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">    _source:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">"silence"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>pretty: 表示在已json格式返回数据时是否以可视化的格式返回, false或未在设置表示不格式化, 否则格式化</p>
</li>
<li><p>human: 表示是否对返回结果进行格式化处理，比如3600(s)显示1h</p>
</li>
<li><p>查询结果过滤<br>主要使用filter_path参数进行设置</p>
</li>
</ul>
<p>1.在返回结果中我们只关注took, hits.total, hits.hits._id, hits._source, 则我们可以发起如此请求:<br>输入:<code>GET /test1/user/_search?filter_path=took,hits.total,hits.hits._id,hits.hits._source</code><br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"took"</span>: <span class="number">1</span>,</span><br><span class="line">   <span class="attr">"hits"</span>: &#123;</span><br><span class="line">      <span class="attr">"total"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"hits"</span>: [</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"_source"</span>: &#123;</span><br><span class="line">               <span class="attr">"name"</span>: <span class="string">"silence"</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>2.也可以使用统配符进行设置<br>输入: <code>GET /_nodes/stats?filter_path=nodes.*.*ost*,nodes.*.os.*u</code><br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"nodes"</span>: &#123;</span><br><span class="line">      <span class="attr">"9jfW4VeWRta-Uq7Cq7bK34"</span>: &#123;</span><br><span class="line">         <span class="attr">"host"</span>: <span class="string">"silence"</span>,</span><br><span class="line">         <span class="attr">"os"</span>: &#123;</span><br><span class="line">            <span class="attr">"cpu"</span>: &#123;</span><br><span class="line">               <span class="attr">"sys"</span>: <span class="number">1</span>,</span><br><span class="line">               <span class="attr">"user"</span>: <span class="number">1</span>,</span><br><span class="line">               <span class="attr">"idle"</span>: <span class="number">96</span>,</span><br><span class="line">               <span class="attr">"usage"</span>: <span class="number">2</span>,</span><br><span class="line">               <span class="attr">"stolen"</span>: <span class="number">0</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>3.若层级较多时可使用**进行简化<br>输入: <code>GET /_nodes/stats?filter_path=nodes.**.*sys*</code><br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"nodes"</span>: &#123;</span><br><span class="line">      <span class="attr">"9jfW4VeWRta-Uq7Cq7bK34"</span>: &#123;</span><br><span class="line">         <span class="attr">"os"</span>: &#123;</span><br><span class="line">            <span class="attr">"cpu"</span>: &#123;</span><br><span class="line">               <span class="attr">"sys"</span>: <span class="number">2</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="attr">"process"</span>: &#123;</span><br><span class="line">            <span class="attr">"cpu"</span>: &#123;</span><br><span class="line">               <span class="attr">"sys_in_millis"</span>: <span class="number">139106</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>4.若只需要_source中的某些值，则可以将filter_path和_source参数共同使用<br>输入: <code>GET /test1/account/_search?filter_path=hits.hits._source&amp;_source=firstname,lastname,gender&amp;size=2</code><br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"hits"</span>: &#123;</span><br><span class="line">      <span class="attr">"hits"</span>: [</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="attr">"_source"</span>: &#123;</span><br><span class="line">               <span class="attr">"firstname"</span>: <span class="string">"Rodriquez"</span>,</span><br><span class="line">               <span class="attr">"gender"</span>: <span class="string">"F"</span>,</span><br><span class="line">               <span class="attr">"lastname"</span>: <span class="string">"Flores"</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="attr">"_source"</span>: &#123;</span><br><span class="line">               <span class="attr">"firstname"</span>: <span class="string">"Opal"</span>,</span><br><span class="line">               <span class="attr">"gender"</span>: <span class="string">"M"</span>,</span><br><span class="line">               <span class="attr">"lastname"</span>: <span class="string">"Meadows"</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.flat_settings用于设置在查询setting时,setting中的key格式, 默认为false:<br>输入: <code>GET /test1/_settings?flat_settings=true</code><br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"test1"</span>: &#123;</span><br><span class="line">      <span class="attr">"settings"</span>: &#123;</span><br><span class="line">         <span class="attr">"index.creation_date"</span>: <span class="string">"1442230557598"</span>,</span><br><span class="line">         <span class="attr">"index.uuid"</span>: <span class="string">"70bg061IRdKUdDNvgkUBoQ"</span>,</span><br><span class="line">         <span class="attr">"index.version.created"</span>: <span class="string">"1060099"</span>,</span><br><span class="line">         <span class="attr">"index.number_of_replicas"</span>: <span class="string">"1"</span>,</span><br><span class="line">         <span class="attr">"index.number_of_shards"</span>: <span class="string">"5"</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输入: <code>GET /test1/_settings?flat_settings=false</code><br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"test1"</span>: &#123;</span><br><span class="line">      <span class="attr">"settings"</span>: &#123;</span><br><span class="line">         <span class="attr">"index"</span>: &#123;</span><br><span class="line">            <span class="attr">"creation_date"</span>: <span class="string">"1442230557598"</span>,</span><br><span class="line">            <span class="attr">"number_of_shards"</span>: <span class="string">"5"</span>,</span><br><span class="line">            <span class="attr">"uuid"</span>: <span class="string">"70bg061IRdKUdDNvgkUBoQ"</span>,</span><br><span class="line">            <span class="attr">"version"</span>: &#123;</span><br><span class="line">               <span class="attr">"created"</span>: <span class="string">"1060099"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"number_of_replicas"</span>: <span class="string">"1"</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>请求参数格式<br>1.boolean: 在es中将”0”, 0, false, “false”, “off”识别为false，其他均按ture处理<br>2.number<br>3.time: 可以提交一个以毫秒时间的整数或者以日期标识结尾的字符串，例如”2d”表示2天，支持的格式有: y(year),M(month),w(week),d(day),h(hour),m(minute),s(second)<br>4.距离: 可以提交一个以米为单位的证书或者以距离表示结尾的字符串，例如”2km”表示2千米，支持的格式有: mi/miles(mile英里), yd/yards(yard码), ft/feet(feet尺), in/inch(inch英寸), km/kilometers(kilometer千米), m/meters(meter米), cm/centimeters(centimeter厘米), mm/millimeters(millimeter毫米), NM/nmi/nauticalmiles(Nautical mile纳米)<br>5.模糊类型:<br>  a.数字,时间, IP：类似于range -fuzzines&lt;=value&lt;=+fuzzines<br>  b.字符串: 计算编辑距离</p>
</li>
<li><p>返回结果中key的格式为驼峰还是下划线分割, 通过case设置为camelCase则返回驼峰格式，否则为下划线分割形式</p>
</li>
<li>jsonp: 可以用jsonp回调的方式调用es api, 需要通过callback设置回调函数名称，并且需要在elasticsearch.yml中配置<code>http.jsonp.enable: true</code>来启用jsonp格式</li>
</ul>
<h2 id="url访问控制"><a href="#url访问控制" class="headerlink" title="url访问控制"></a>url访问控制</h2><p>可以通过代理方式进行es的url访问控制，但是对于multi-search，multi-get和bulk等在请求参数中设置不同的index的情况很难解决.<br>为防止通过请求体设置index的情况,需要在elasticsearch.yml中设置<code>rest.action.multi.allow_explicit_index:false</code>, 此时es不允许在request body中设置index</p>
<p>如在修改前：<br>输入:<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /test1/user3/_bulk?pretty</span><br><span class="line">&#123;<span class="string">"index"</span> : &#123;<span class="string">"_index"</span> : <span class="string">"test2"</span>, <span class="string">"_type"</span> : <span class="string">"user1"</span>, <span class="string">"_id"</span> : <span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span> : <span class="string">"silence1"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span> : &#123;<span class="string">"_index"</span> : <span class="string">"test2"</span>, <span class="string">"_type"</span> : <span class="string">"user1"</span>, <span class="string">"_id"</span> : <span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span> : <span class="string">"silence2"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"took"</span>: <span class="number">225</span>,</span><br><span class="line">   <span class="attr">"errors"</span>: <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">"items"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"index"</span>: &#123;</span><br><span class="line">            <span class="attr">"_index"</span>: <span class="string">"test2"</span>,</span><br><span class="line">            <span class="attr">"_type"</span>: <span class="string">"user1"</span>,</span><br><span class="line">            <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"status"</span>: <span class="number">201</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"index"</span>: &#123;</span><br><span class="line">            <span class="attr">"_index"</span>: <span class="string">"test2"</span>,</span><br><span class="line">            <span class="attr">"_type"</span>: <span class="string">"user1"</span>,</span><br><span class="line">            <span class="attr">"_id"</span>: <span class="string">"2"</span>,</span><br><span class="line">            <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"status"</span>: <span class="number">201</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如在修改后(已重启)：<br>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"error"</span>: <span class="string">"IllegalArgumentException[explicit index in bulk is not allowed]"</span>,</span><br><span class="line">   <span class="attr">"status"</span>: <span class="number">500</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输入:<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /test1/user3/_bulk?pretty</span><br><span class="line">&#123;<span class="string">"index"</span> : &#123;<span class="string">"_id"</span> : <span class="number">1</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span> : <span class="string">"silence1"</span>&#125;</span><br><span class="line">&#123;<span class="string">"index"</span> : &#123;<span class="string">"_id"</span> : <span class="number">2</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"name"</span> : <span class="string">"silence2"</span>&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"took"</span>: <span class="number">8</span>,</span><br><span class="line">   <span class="attr">"errors"</span>: <span class="literal">false</span>,</span><br><span class="line">   <span class="attr">"items"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"index"</span>: &#123;</span><br><span class="line">            <span class="attr">"_index"</span>: <span class="string">"test1"</span>,</span><br><span class="line">            <span class="attr">"_type"</span>: <span class="string">"user3"</span>,</span><br><span class="line">            <span class="attr">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"status"</span>: <span class="number">201</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"index"</span>: &#123;</span><br><span class="line">            <span class="attr">"_index"</span>: <span class="string">"test1"</span>,</span><br><span class="line">            <span class="attr">"_type"</span>: <span class="string">"user3"</span>,</span><br><span class="line">            <span class="attr">"_id"</span>: <span class="string">"2"</span>,</span><br><span class="line">            <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"status"</span>: <span class="number">201</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/09/16/elasticsearch/elasticsearch_max_open_files/" itemprop="url">
                记一次修改elasticsearch文件描述符数量
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-16T13:20:21+08:00" content="2015-09-16">
            2015-09-16
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/存储/" itemprop="url" rel="index"><span itemprop="name">存储</span></a></span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/09/16/elasticsearch/elasticsearch_max_open_files/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/09/16/elasticsearch/elasticsearch_max_open_files/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><p>背景：在某年某月某日发现es运行不正常，查看日志发现如下错误<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java<span class="selector-class">.io</span><span class="selector-class">.IOException</span>: Too many open files</span><br></pre></td></tr></table></figure></p>
<p>以下为操作步骤:<br>1.查看es节点信息结果:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"nodes"</span> : &#123;</span><br><span class="line">    <span class="attr">"eE4eHSOWTK-j6IO7JJzcXG"</span> : &#123;</span><br><span class="line">      <span class="attr">"name"</span> : <span class="string">"Hardcore"</span>,</span><br><span class="line">      <span class="attr">"transport_address"</span> : <span class="string">"inet[silence/192.168.1.111:9300]"</span>,</span><br><span class="line">      <span class="attr">"host"</span> : <span class="string">"silence"</span>,</span><br><span class="line">      <span class="attr">"ip"</span> : <span class="string">"192.168.1.111"</span>,</span><br><span class="line">      <span class="attr">"version"</span> : <span class="string">"1.6.0"</span>,</span><br><span class="line">      <span class="attr">"build"</span> : <span class="string">"cdd3ac4"</span>,</span><br><span class="line">      <span class="attr">"http_address"</span> : <span class="string">"inet[/192.168.1.111:9200]"</span>,</span><br><span class="line">      <span class="attr">"process"</span> : &#123;</span><br><span class="line">        <span class="attr">"refresh_interval_in_millis"</span> : <span class="number">1000</span>,</span><br><span class="line">        <span class="attr">"id"</span> : <span class="number">10598</span>,</span><br><span class="line">        <span class="attr">"max_file_descriptors"</span> : <span class="number">32768</span>,</span><br><span class="line">        <span class="attr">"mlockall"</span> : <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>疑问：明明在/etc/init.d/elasticsearch启动脚本中设置了<code>MAX_OPEN_FILES=65535</code>, 且执行<code>ulimits -n $MAX_OPEN_FILES</code>成功, 但是es节点信息中max_file_descriptors始终为32768</p>
<p>2.查看/etc/init.d/elasticsearch启动脚本内容，在启动进程时使用/etc/init.d/functions下的daemon函数启动，最终追溯到daemon使用<code>runuser -s /bin/bash $user -c &quot;$corelimit &gt;/dev/null 2&gt;&amp;1 ; $*&quot;</code>方式启动进程，自然想要在-c中添加ulimit -n 65535, 结果以失败告终，启动脚本报错<code>ulimit: open files: cannot modify limit: Operation not permitted</code>，自己在命令行下发现普通用户在修改时报错, 而root用户就ok</p>
<p>3.修改/etc/security/limits.conf文件添加如下内容(es运行用户为elasticsearch)<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch        hard     nofile         <span class="number">65535</span></span><br><span class="line">elasticsearch        <span class="keyword">soft</span>     nofile         <span class="number">65535</span></span><br></pre></td></tr></table></figure></p>
<p>修改内容后重启es, 启动后查询es节点信息max_file_descriptors还是为32768 … 此时已疯</p>
<p>4.查看谷歌，说/etc/pam.d/login文件中需要有<code>session     required      pam_limits.so</code> limits.conf文件才会起效，于是乎，我加上了，结果…尼玛咋还是32768呢<br>5.再次查看/etc/pam.d/login发现有这么一句话<code>session    include      system-auth</code>, 一看就是导入了文件system-auth, 于是在system-auth中发现已经存在<code>session     required      pam_limits.so</code>，然后尼玛删除步骤3添加的内容<br>6.此时想到反编译pam_limits.so文件看看到底干了什么事, 当然先得查询文件在哪 <code>find / -name pam_limits.so</code><br>然后使用<code>strings pam_limits.so</code> 结果尼玛发现其中有这么两行:<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/security/limits.conf</span><br><span class="line"><span class="bullet">.</span><br><span class="line"></span><span class="bullet">.</span><br><span class="line"></span><span class="bullet">.</span><br><span class="line"></span>/etc/security/limits.d/<span class="strong">*.conf</span></span><br></pre></td></tr></table></figure></p>
<p>自然想查看/etc/security/limits.d/下的*.conf结果，发现了def.conf，内容为:<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">*        </span>hard     nofile         32768</span><br><span class="line"><span class="bullet">*        </span>soft     nofile         32768</span><br></pre></td></tr></table></figure></p>
<p>说明: *表示对所有用户生效</p>
<p>结果自然要试试修改def.conf文件，结果这次ok了</p>
<p>分析原因：<br>1.why在/etc/init.d/elasticsearch中已经设置ulimit -n为啥没有生效<br>runuser命令格式:<code>runuser -s [shell] [uid/gid] -c &quot;command&quot;</code>, 说明:使用一个替代的用户或组ID运行一个Shell, 只有会话的PAM hooks运行, 并且没有密码提示, 这个命令仅在root用户时有用<br>根据测试也知道ulimit -n只是修改当前会话中的打开文件描述符数量, 当打开新回话时或切换新用户则失效。并根据描述得知runuser在打开会话之后PAM hooks认证模块会执行，因此在此前的设置参数都无效</p>
<p>2.why在runuser时在-c中添加ulimit -n 65535报错<br>查找资料发现, 普通用户在设置ulimit -n时其大小不能超过预设置的值, 那预设置的值是谁呢, 自然就想到limits.conf，可以自己测试在limits.conf中添加自己的用户信息(silence is me)，可以发现再次修改则正常<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">silence        hard     nofile         <span class="number">65535</span></span><br><span class="line">silence        <span class="keyword">soft</span>     nofile         <span class="number">65535</span></span><br></pre></td></tr></table></figure></p>
<p>3.limits.conf和limits.d/*.conf的关系<br>此时自然想到的是文件加载顺序和配置内容有关，配置相同的内容但是值不通时，后加载的配置文件的值会生效呢, 我们做一下测试:在limits.d/def.conf配置文件中添加一下信息，因为第2步已经在limit.conf中设置其值为65535并测试成功，那么此时若我们再测试<code>ulimit -n 50000</code>正常而<code>ulimit -n 65535</code> 不正常自然可以验证我们的猜测<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">silence</span>        hard     nofile         <span class="number">50000</span></span><br></pre></td></tr></table></figure></p>
<p>结果自然与猜测一致<br>根据反编译的结果pam_limits.so会先加载limits.conf然后再加载limits.d/<em>.conf此时有一定顺序, 但是limits.d/</em>.conf中加载顺序如何呢? 猜测与系统排序有关，但未测试，在通常情况下好的系统管理员对不同用户应该根据userid在limits.d下建立不同的文件单独配置，方便管理<br>为什么在limits.d/def.conf中值设置hard值呢？可以查看配置文件的规则，hard设置为允许修改的最大值而soft设置的是新回话生成时默认设置</p>
<p>4.此时你应该会问这个值到底可以设置多大?<br>查看文件/proc/sys/fs/file-max和/proc/sys/fs/file-nr内容<br>输入: <code>cat /proc/sys/fs/file-max</code><br>输出: <code>191832</code></p>
<p>输入: <code>cat/proc/sys/fs/file-nr</code><br>输出: <code>1792  0 191832</code></p>
<p>查阅GOOGLE, file-nr文件中的三个数分别表示: 系统已经分配的文件句柄数, 没有用到的句柄数和所有可分配的最大句柄数，file-max中的值为最大所能分配的句柄数, 因此在ulimit -n是设置的值不能超过file-max记录的值<br>file-nr文件内容通常由在系统启动时根据系统内存计算得出，系统内存增大则file-max增大</p>
<p>5.如何查看其他进程当前设置的max_file_descriptors<br>对于linux内核为2.6.24及以后版本<br>输入: <code>cat /proc/34690/limits | grep &quot;Max open files&quot;</code><br>输出: <code>Max open files            32768                32768                files</code></p>
<p>6.如何查看某进程当前打开的文件句柄数:<br>输入: <code>lsof -n|awk &#39;{print $2}&#39;|sort|uniq -c|sort -nr|grep pid</code><br>输出: <code>cnt pid</code></p>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              <a class="post-title-link" href="/2015/09/15/elasticsearch/elasticsearch_03/" itemprop="url">
                elasticsearch 第三篇(安装篇)
              </a>
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-09-15T18:08:21+08:00" content="2015-09-15">
            2015-09-15
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/存储/" itemprop="url" rel="index"><span itemprop="name">存储</span></a></span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/09/15/elasticsearch/elasticsearch_03/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/09/15/elasticsearch/elasticsearch_03/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody"><h2 id="nux下安装"><a href="#nux下安装" class="headerlink" title="*nux下安装"></a>*nux下安装</h2><p>在*nux下，es官方已提供编译的deb和rpm包，但是需要保证已安装安装java虚拟环境（目前es1.6和1.7版本均可选择1.8版本java），安装步骤如下：<br>1.<a href="https://www.elastic.co/downloads/elasticsearch" title="elasticsearch" target="_blank" rel="external">下载ES deb/rpm包</a>，并执行安命令<br>deb包安装: <code>dpkg -i elasticsearch-1.6.0.deb</code><br>rpm包安装: <code>rpm -i elasticsearch-1.6.0.rpm</code></p>
<p>2.安装后需要将es服务更新随系统启动</p>
<ul>
<li><p>对于Debian/Ubuntu系统<br>执行: <code>update-rc.d elasticsearch defaults</code><br>系统服务控制: <code>/etc/init.d/elasticsearch start/stop/restart</code></p>
</li>
<li><p>对于redhat/centos系统<br>执行: <code>chkconfig -add elasticsearch</code><br>系统服务控制: <code>service elasticsearch start/stop/restart</code></p>
</li>
</ul>
<p>3.若需要修改es启动参数，可直接在/etc/init.d/elasticsearch脚本中修改然后从其服务器</p>
<h2 id="windows下安装"><a href="#windows下安装" class="headerlink" title="windows下安装"></a>windows下安装</h2><p>在windows下es安装比较简单，当然也需要提前安装好java虚拟环境，以下为es安装步骤：<br>1.<a href="https://www.elastic.co/downloads/elasticsearch" title="elasticsearch" target="_blank" rel="external">下载zip包</a>并解压到安装目录<br>2.通过es_home/bin/service.bat将es注册到windows服务中(注意需要使用管理员权限运行),service.bat命令格式:<code>service.bat install|remove|start|stop|manager [server_name]</code></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>install</td>
<td>将es安装到windows服务中</td>
</tr>
<tr>
<td>remove</td>
<td>将es从windows服务中移除</td>
</tr>
<tr>
<td>start</td>
<td>服务启动</td>
</tr>
<tr>
<td>stop</td>
<td>服务停止</td>
</tr>
<tr>
<td>manager</td>
<td>管理gui</td>
</tr>
</tbody>
</table>
<p>在未设置安装服务时若未设置server_name时，则命令使用默认名称，在执行service.bat脚本时也不需要指定server_name参数，否则需要手动指定server_name才能执行</p>
<p>3.若需要修改es启动参数，可使用<code>service.bat manager [server_name]</code>打开GUI窗口，在”java”选项卡中设置启动参数后重启服务</p>
<h2 id="es目录解释"><a href="#es目录解释" class="headerlink" title="es目录解释"></a>es目录解释</h2><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch                     -- <span class="built_in">path</span>.home, es的安装目录</span><br><span class="line">├─bin                             -- $&#123;<span class="built_in">path</span>.home&#125;/bin, 启动脚本方式目录</span><br><span class="line">├─config                          -- $&#123;<span class="built_in">path</span>.home&#125;/config, 配置文件目录</span><br><span class="line">├─<span class="keyword">data</span>                            -- $&#123;<span class="built_in">path</span>.home&#125;/<span class="keyword">data</span>, 数据存放目录</span><br><span class="line">│  └─elasticsearch                -- $&#123;<span class="built_in">path</span>.home&#125;/<span class="keyword">data</span>/$&#123;cluster.<span class="keyword">name</span>&#125;</span><br><span class="line">├─lib                             -- $&#123;<span class="built_in">path</span>.home&#125;/lib, 运行程序目录</span><br><span class="line">├─logs                            -- $&#123;<span class="built_in">path</span>.home&#125;/logs, <span class="built_in">log</span>目录 </span><br><span class="line">└─plugins                         -- $&#123;<span class="built_in">path</span>.home&#125;/plugins, 插件目录</span><br><span class="line">    ├─head</span><br><span class="line">    │  └─...</span><br><span class="line">    └─marvel</span><br><span class="line">        └─...</span><br></pre></td></tr></table></figure>
<p>es支持将data目录配置为多个，可通过在进程启动时通过-Des.index.store.distributor设置在存储数据时选择的目录:</p>
<table>
<thead>
<tr>
<th>参数值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>least_used</td>
<td>默认值,选择剩余存储空间最大的目录</td>
</tr>
<tr>
<td>random</td>
<td>随机选取，选择的概率和目录剩余存储空间大小有关</td>
</tr>
</tbody>
</table>
<p>该方案提供类似raid0(把连续的数据分散到不同的磁盘存储)的方式,配置也比较简单:<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path.<span class="string">data:</span> <span class="regexp">/path/</span>to<span class="regexp">/data1,/</span>path<span class="regexp">/to/</span>data2</span><br></pre></td></tr></table></figure></p>
<p>在*nix下使用deb/rpm安装包安装,通常会修改各文件夹的安装路径,默认安装路径如下:</p>
<table>
<thead>
<tr>
<th>type</th>
<th>debian/ubuntu</th>
<th>redhat/centos</th>
</tr>
</thead>
<tbody>
<tr>
<td>home</td>
<td>/usr/share/elasticsearch</td>
<td>/usr/share/elasticsearch</td>
</tr>
<tr>
<td>bin</td>
<td>/usr/share/elasticsearch/bin</td>
<td>/usr/share/elasticsearch/bin</td>
</tr>
<tr>
<td>config(file)</td>
<td>/etc/elasticsearch</td>
<td>/etc/elasticsearch</td>
</tr>
<tr>
<td>config(env)</td>
<td>/etc/default/elasticseach</td>
<td>/etc/sysconfig/elasticseach</td>
</tr>
<tr>
<td>data</td>
<td>/var/lib/elasticsearch/data</td>
<td>/var/lib/elasticsearch</td>
</tr>
<tr>
<td>logs</td>
<td>/var/log/elasticsearch</td>
<td>/var/log/elasticsearch</td>
</tr>
<tr>
<td>plugins</td>
<td>/usr/share/elasticsearch/plugins</td>
<td>/usr/share/elasticsearch/plugins</td>
</tr>
</tbody>
</table>
</span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/">&laquo;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/6/">&raquo;</a>
  </nav>


            </div>

            

            
        </div>

        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.jpg" alt="Silence" itemprop="image"/>
          <p class="site-author-name" itemprop="name">Silence</p>
        </div>
        <p class="site-description motion-element" itemprop="description">少年经不得顺境,中年经不得闲境,晚年经不得逆境</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">39</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">27</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/imsilence" target="_blank">GitHub</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="copyright" >
  
  &copy; &nbsp;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Silence</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



        </div>
    </footer>

    <div class="back-to-top"></div>
</div>

<script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"imsilence"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  

  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.4"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.4"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.4" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>



<script type="text/javascript">
    $(document).ready(function () {
        if (CONFIG.sidebar === 'always') {
            displaySidebar();
        }
    });
</script>


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"imsilence"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  

  





<!-- lazyload -->
<script type="text/javascript" src="/js/lazyload.js"></script>
<script type="text/javascript">
    jQuery(function () {
        jQuery("#posts img").lazyload({
            placeholder: "/images/loading.gif",
            effect: "fadeIn"
        });
    });
</script>
</body>
</html>
